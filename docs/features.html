---

title: 01 Features generation


keywords: fastai
sidebar: home_sidebar

summary: "scripts for generating features from raw. I will be reading from the **raw** (zip file) and output all the features (both on user and geolocation level) to **Data/L1**"
description: "scripts for generating features from raw. I will be reading from the **raw** (zip file) and output all the features (both on user and geolocation level) to **Data/L1**"
nb_path: "01_features.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 01_features.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Library">Library<a class="anchor-link" href="#Library"> </a></h1>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">zipfile</span> <span class="kn">import</span> <span class="n">ZipFile</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">spatial</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">tsfresh</span> <span class="kn">import</span> <span class="n">extract_features</span>
<span class="kn">from</span> <span class="nn">tsfresh.feature_selection.relevance</span> <span class="kn">import</span> <span class="n">calculate_relevance_table</span>
<span class="kn">import</span> <span class="nn">tsfresh</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Functions">Functions<a class="anchor-link" href="#Functions"> </a></h1>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="read_tsv" class="doc_header"><code>read_tsv</code><a href="https://github.com/minghao51/telco_churn_zig/tree/master/telco_churn_zig/L1_features_gen.py#L21" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>read_tsv</code>(<strong><code>file</code></strong>:<code>str</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="gzip_reading" class="doc_header"><code>gzip_reading</code><a href="https://github.com/minghao51/telco_churn_zig/tree/master/telco_churn_zig/L1_features_gen.py#L24" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>gzip_reading</code>(<strong><code>gzip_file</code></strong>)</p>
</blockquote>
<p>Read all tsv.gz files in the zip file and returning a dictionary (key:filename, value:data)</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="school_plan__features" class="doc_header"><code>school_plan__features</code><a href="https://github.com/minghao51/telco_churn_zig/tree/master/telco_churn_zig/L1_features_gen.py#L37" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>school_plan__features</code>(<strong><code>data</code></strong>:<code>DataFrame</code>)</p>
</blockquote>
<p>Calculate the number of school (and its associated types) within the planning area</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="translate_latlng" class="doc_header"><code>translate_latlng</code><a href="https://github.com/minghao51/telco_churn_zig/tree/master/telco_churn_zig/L1_features_gen.py#L47" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>translate_latlng</code>(<strong><code>input</code></strong>:<code>list</code>)</p>
</blockquote>
<p>Translating the lat lng into tuple format, to be used to mathematically identify the nearest neighbor</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="kdtree_neighbors" class="doc_header"><code>kdtree_neighbors</code><a href="https://github.com/minghao51/telco_churn_zig/tree/master/telco_churn_zig/L1_features_gen.py#L53" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>kdtree_neighbors</code>(<strong><code>reference</code></strong>:<code>list</code>, <strong><code>query_data</code></strong>:<code>list</code>)</p>
</blockquote>
<p>Identify the nearest neighbor for <em>query_data</em>[list of (lat,lng)] to the <em>reference</em>[list of (lat,lng)], returning the matching reference index</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="train_plan__latlng" class="doc_header"><code>train_plan__latlng</code><a href="https://github.com/minghao51/telco_churn_zig/tree/master/telco_churn_zig/L1_features_gen.py#L58" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>train_plan__latlng</code>(<strong><code>data</code></strong>:<code>DataFrame</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="train_plan__nbusers" class="doc_header"><code>train_plan__nbusers</code><a href="https://github.com/minghao51/telco_churn_zig/tree/master/telco_churn_zig/L1_features_gen.py#L64" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>train_plan__nbusers</code>(<strong><code>data</code></strong>:<code>DataFrame</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="train_time_features" class="doc_header"><code>train_time_features</code><a href="https://github.com/minghao51/telco_churn_zig/tree/master/telco_churn_zig/L1_features_gen.py#L67" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>train_time_features</code>(<strong><code>data</code></strong>:<code>DataFrame</code>)</p>
</blockquote>
<p>Modify the train dataset inplace to generate time features (<em>month_delta</em> and <em>account start year</em>)</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="census_income_median" class="doc_header"><code>census_income_median</code><a href="https://github.com/minghao51/telco_churn_zig/tree/master/telco_churn_zig/L1_features_gen.py#L74" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>census_income_median</code>(<strong><code>data</code></strong>:<code>DataFrame</code>)</p>
</blockquote>
<p>Calculate the median income and working pop for region excluding outliers (above 10K SGD and 0 SGD)</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="census_income_avg" class="doc_header"><code>census_income_avg</code><a href="https://github.com/minghao51/telco_churn_zig/tree/master/telco_churn_zig/L1_features_gen.py#L84" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>census_income_avg</code>(<strong><code>data</code></strong>:<code>DataFrame</code>)</p>
</blockquote>
<p>Calculate average income based on the avg(pop * income)</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="gini_processing" class="doc_header"><code>gini_processing</code><a href="https://github.com/minghao51/telco_churn_zig/tree/master/telco_churn_zig/L1_features_gen.py#L95" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>gini_processing</code>(<strong><code>census_perc_dt_melt</code></strong>:<code>DataFrame</code>)</p>
</blockquote>
<p>Parsing the income percent into np.array for gini calculation</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="gini" class="doc_header"><code>gini</code><a href="https://github.com/minghao51/telco_churn_zig/tree/master/telco_churn_zig/L1_features_gen.py#L127" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>gini</code>(<strong><code>array</code></strong>)</p>
</blockquote>
<p>Calculate the Gini coefficient of a numpy array.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="census_sentiment_analy" class="doc_header"><code>census_sentiment_analy</code><a href="https://github.com/minghao51/telco_churn_zig/tree/master/telco_churn_zig/L1_features_gen.py#L144" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>census_sentiment_analy</code>(<strong><code>input</code></strong>:<code>str</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="convert_sent2score" class="doc_header"><code>convert_sent2score</code><a href="https://github.com/minghao51/telco_churn_zig/tree/master/telco_churn_zig/L1_features_gen.py#L148" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>convert_sent2score</code>(<strong><code>input</code></strong>:<code>dict</code>)</p>
</blockquote>
<p>Extract and convert the sentimental assignemnt to 0 (Negative), 0.5 (Neutral), 1 (Positive)</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="transform_churn_series" class="doc_header"><code>transform_churn_series</code><a href="https://github.com/minghao51/telco_churn_zig/tree/master/telco_churn_zig/L1_features_gen.py#L160" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>transform_churn_series</code>(<strong><code>extracted_features_dt</code></strong>:<code>DataFrame</code>, <strong><code>dt_churn</code></strong>:<code>DataFrame</code>)</p>
</blockquote>
<p>Extract churn data for significant test in x</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">read_tsv</span><span class="p">(</span><span class="n">file</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span>  <span class="n">compression</span><span class="o">=</span><span class="s1">&#39;gzip&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">gzip_reading</span><span class="p">(</span><span class="n">gzip_file</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">dict</span><span class="p">:</span>
    <span class="s1">&#39;Read all tsv.gz files in the zip file and returning a dictionary (key:filename, value:data)&#39;</span>
    <span class="n">archive</span> <span class="o">=</span> <span class="n">ZipFile</span><span class="p">(</span><span class="n">gzip_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">files</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">archive</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">archive</span><span class="o">.</span><span class="n">namelist</span><span class="p">()</span> <span class="k">if</span>
     <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.gz&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">))}</span>
    <span class="n">files_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">files</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
    
    <span class="c1"># reading the designated files into dict</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">files_names</span><span class="p">,</span> <span class="n">files</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">dt</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_tsv</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">dt</span>

<span class="k">def</span> <span class="nf">school_plan__features</span><span class="p">(</span><span class="n">data</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="s1">&#39;Calculate the number of school (and its associated types) within the planning area&#39;</span>
    <span class="n">school_count</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;planning_area&#39;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;size&#39;</span><span class="p">:</span><span class="s1">&#39;number_school&#39;</span><span class="p">},</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">school_cat_count</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span>
                        <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;planning_area&#39;</span><span class="p">,</span><span class="s1">&#39;category&#39;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
                        <span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;size&#39;</span><span class="p">:</span><span class="s1">&#39;number_school&#39;</span><span class="p">},</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;planning_area&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;category&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;number_school&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                       <span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">school_count</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">school_cat_count</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">translate_latlng</span><span class="p">(</span><span class="nb">input</span><span class="p">:</span><span class="nb">list</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">list</span><span class="p">:</span>
    <span class="s1">&#39;Translating the lat lng into tuple format, to be used to mathematically identify the nearest neighbor&#39;</span>
    <span class="n">latlong_location_str</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">input</span><span class="p">]</span>
    <span class="n">latlong_location_num</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">y</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">latlong_location_str</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">latlong_location_num</span>

<span class="k">def</span> <span class="nf">kdtree_neighbors</span><span class="p">(</span><span class="n">reference</span><span class="p">:</span><span class="nb">list</span><span class="p">,</span> <span class="n">query_data</span><span class="p">:</span><span class="nb">list</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">list</span><span class="p">:</span>
    <span class="s1">&#39;Identify the nearest neighbor for *query_data*[list of (lat,lng)] to the *reference*[list of (lat,lng)], returning the matching reference index&#39;</span>
    <span class="n">tree</span> <span class="o">=</span> <span class="n">spatial</span><span class="o">.</span><span class="n">KDTree</span><span class="p">(</span><span class="n">reference</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tree</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">query_data</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">train_plan__latlng</span><span class="p">(</span><span class="n">data</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="n">list_tuple_latlng</span> <span class="o">=</span>  <span class="n">translate_latlng</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;latlong&#39;</span><span class="p">])</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">list_tuple_latlng</span><span class="p">]</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;lng&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">list_tuple_latlng</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;planning_area&#39;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[[</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span><span class="s1">&#39;lng&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">train_plan__nbusers</span><span class="p">(</span><span class="n">data</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;planning_area&#39;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;size&#39;</span><span class="p">:</span><span class="s1">&#39;users_nb&#39;</span><span class="p">},</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">train_time_features</span><span class="p">(</span><span class="n">data</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
    <span class="s1">&#39;Modify the train dataset inplace to generate time features (*month_delta* and *account start year*)&#39;</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;account_start_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;account_start_date&#39;</span><span class="p">])</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;reference_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;reference_date&#39;</span><span class="p">])</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;month_delta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;reference_date&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;account_start_date&#39;</span><span class="p">])]</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;account_start_year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">year</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;account_start_date&#39;</span><span class="p">]]</span>
    
<span class="k">def</span> <span class="nf">census_income_median</span><span class="p">(</span><span class="n">data</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>    
    <span class="s1">&#39;Calculate the median income and working pop for region excluding outliers (above 10K SGD and 0 SGD)&#39;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">data</span>
            <span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">12000</span><span class="p">,</span><span class="mi">0</span><span class="p">])]</span>
            <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">([</span><span class="s1">&#39;planning_area&#39;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;variable&#39;</span><span class="p">:</span><span class="s1">&#39;med_income&#39;</span><span class="p">,</span><span class="s1">&#39;value&#39;</span><span class="p">:</span><span class="s1">&#39;working_pop&#39;</span><span class="p">},</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;working_pop&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
           <span class="p">)</span>

<span class="k">def</span> <span class="nf">census_income_avg</span><span class="p">(</span><span class="n">data</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="s1">&#39;Calculate average income based on the avg(pop * income)&#39;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">census_income_dt_melt</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">temp</span><span class="o">=</span><span class="n">census_income_dt_melt</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s1">&#39;variable * value&#39;</span><span class="p">))</span>
             <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;planning_area&#39;</span><span class="p">)[[</span><span class="s1">&#39;temp&#39;</span><span class="p">,</span><span class="s1">&#39;value&#39;</span><span class="p">]]</span>
             <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
             <span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s1">&#39;temp / value&#39;</span><span class="p">)</span>
             <span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="s1">&#39;avg_income&#39;</span><span class="p">)</span>
             <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="p">)</span>

<span class="k">def</span> <span class="nf">gini_processing</span><span class="p">(</span><span class="n">census_perc_dt_melt</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="s1">&#39;Parsing the income percent into np.array for gini calculation&#39;</span>
    <span class="n">income_per_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;no_working_person_percent&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> 
     <span class="s1">&#39;below_sgd_1000_percent&#39;</span><span class="p">:</span><span class="o">.</span><span class="mi">05</span><span class="p">,</span>
     <span class="s1">&#39;sgd_10000_over_percent&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> 
     <span class="s1">&#39;sgd_1000_to_1999_percent&#39;</span><span class="p">:</span><span class="o">.</span><span class="mi">15</span><span class="p">,</span> 
     <span class="s1">&#39;sgd_2000_to_2999_percent&#39;</span><span class="p">:</span><span class="o">.</span><span class="mi">25</span><span class="p">,</span>
     <span class="s1">&#39;sgd_3000_to_3999_percent&#39;</span><span class="p">:</span><span class="o">.</span><span class="mi">35</span><span class="p">,</span> 
     <span class="s1">&#39;sgd_4000_to_4999_percent&#39;</span><span class="p">:</span><span class="o">.</span><span class="mi">45</span><span class="p">,</span> 
     <span class="s1">&#39;sgd_5000_to_5999_percent&#39;</span><span class="p">:</span><span class="o">.</span><span class="mi">55</span><span class="p">,</span>
     <span class="s1">&#39;sgd_6000_to_6999_percent&#39;</span><span class="p">:</span><span class="o">.</span><span class="mi">65</span><span class="p">,</span> 
     <span class="s1">&#39;sgd_7000_to_7999_percent&#39;</span><span class="p">:</span><span class="o">.</span><span class="mi">75</span><span class="p">,</span> 
     <span class="s1">&#39;sgd_8000_to_8999_percent&#39;</span><span class="p">:</span><span class="o">.</span><span class="mi">85</span><span class="p">,</span>
     <span class="s1">&#39;sgd_9000_to_9999_percent&#39;</span><span class="p">:</span><span class="o">.</span><span class="mi">95</span><span class="p">}</span>

    <span class="n">census_perc_dt_melt</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">census_perc_dt_melt</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">income_per_dict</span><span class="p">)</span>
    <span class="n">census_perc_dt_melt</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;planning_area&#39;</span><span class="p">,</span><span class="s1">&#39;variable&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">census_perc_dt_melt</span> <span class="o">=</span> <span class="n">census_perc_dt_melt</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="n">census_perc_dt_melt</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>

    <span class="n">unique_areas</span> <span class="o">=</span> <span class="n">census_perc_dt_melt</span><span class="p">[</span><span class="s1">&#39;planning_area&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="n">gini_dict</span><span class="o">=</span><span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">unique_areas</span><span class="p">:</span> <span class="c1"># looking at individual planning area seperately</span>
        <span class="n">tmp_dt</span> <span class="o">=</span> <span class="n">census_perc_dt_melt</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">census_perc_dt_melt</span><span class="p">[</span><span class="s1">&#39;planning_area&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">i</span><span class="p">][[</span><span class="s1">&#39;variable&#39;</span><span class="p">,</span><span class="s1">&#39;value&#39;</span><span class="p">]]</span> 
        <span class="n">tmp_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">]</span><span class="o">*</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">tmp_dt</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">],</span> <span class="n">tmp_dt</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])]</span> <span class="c1"># creation y records based on x value</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">tmp_list</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="n">gini_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">gini</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

    <span class="n">gini_dt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">gini_dict</span><span class="p">)</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">gini_dt</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;planning_area&#39;</span><span class="p">,</span><span class="s1">&#39;gini_coef&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">gini_dt</span>

<span class="c1"># adapted from https://github.com/oliviaguest/gini</span>
<span class="k">def</span> <span class="nf">gini</span><span class="p">(</span><span class="n">array</span><span class="p">):</span>
    <span class="s1">&#39;Calculate the Gini coefficient of a numpy array.&#39;</span>
    <span class="c1"># based on bottom eq: http://www.statsdirect.com/help/content/image/stat0206_wmf.gif</span>
    <span class="c1"># from: http://www.statsdirect.com/help/default.htm#nonparametric_methods/gini.htm</span>
    <span class="n">array</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="c1">#all values are treated equally, arrays must be 1d</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">array</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">array</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">array</span><span class="p">)</span> <span class="c1">#values cannot be negative</span>
    <span class="n">array</span> <span class="o">+=</span> <span class="mf">0.0000001</span> <span class="c1">#values cannot be 0</span>
    <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">array</span><span class="p">)</span> <span class="c1">#values must be sorted</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#index per array element</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="c1">#number of array elements</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">index</span> <span class="o">-</span> <span class="n">n</span>  <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">array</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">array</span><span class="p">)))</span> <span class="c1">#Gini coefficient</span>


<span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">pipeline</span>
<span class="c1"># Allocate a pipeline for sentiment-analysis</span>
<span class="n">classifier</span> <span class="o">=</span> <span class="n">pipeline</span><span class="p">(</span><span class="s1">&#39;sentiment-analysis&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">census_sentiment_analy</span><span class="p">(</span><span class="nb">input</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">tuple</span><span class="p">:</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">classifier</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output</span>

<span class="k">def</span> <span class="nf">convert_sent2score</span><span class="p">(</span><span class="nb">input</span><span class="p">:</span><span class="nb">dict</span><span class="p">):</span>
    <span class="s1">&#39;Extract and convert the sentimental assignemnt to 0 (Negative), 0.5 (Neutral), 1 (Positive)&#39;</span>
    <span class="n">score_list</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">input</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.7</span><span class="p">:</span>
            <span class="n">score_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;POSITIVE&#39;</span><span class="p">:</span>
            <span class="n">score_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;NEGATIVE&#39;</span><span class="p">:</span>
            <span class="n">score_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">score_list</span>

<span class="k">def</span> <span class="nf">transform_churn_series</span><span class="p">(</span><span class="n">extracted_features_dt</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">dt_churn</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="s1">&#39;Extract churn data for significant test in x&#39;</span>
    <span class="n">churn_dt</span> <span class="o">=</span> <span class="n">dt_churn</span><span class="p">[[</span><span class="s1">&#39;msisdn&#39;</span><span class="p">,</span><span class="s1">&#39;churn&#39;</span><span class="p">]]</span>

    <span class="n">churn_dt_ordered</span> <span class="o">=</span> <span class="p">(</span><span class="n">extracted_features_dt</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()[[</span><span class="s1">&#39;index&#39;</span><span class="p">]]</span>
     <span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;index&#39;</span><span class="p">:</span><span class="s1">&#39;msisdn&#39;</span><span class="p">},</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
     <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">churn_dt</span><span class="p">)</span>
<span class="c1">#      .drop([&#39;voice_incoming__maximum&#39;], axis=1)</span>
     <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;msisdn&#39;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">churn_dt_ordered</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="schools">schools<a class="anchor-link" href="#schools"> </a></h1><p>Allocating the schools data into planning area (base on nearest neighbors), to aggregate it to planning area</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">latlong_school</span> <span class="o">=</span>  <span class="n">translate_latlng</span><span class="p">(</span><span class="n">dt</span><span class="p">[</span><span class="s1">&#39;telco_schools&#39;</span><span class="p">][</span><span class="s1">&#39;latLong&#39;</span><span class="p">])</span>

<span class="c1"># generating unique lat long - planning area data based on users that is used for references mapping</span>
<span class="n">dt_location</span> <span class="o">=</span> <span class="n">dt</span><span class="p">[</span><span class="s1">&#39;telco_train&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;latlong&#39;</span><span class="p">,</span><span class="s1">&#39;planning_area&#39;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s1">&#39;msisdn&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
<span class="n">latlong_users</span> <span class="o">=</span>  <span class="n">translate_latlng</span><span class="p">(</span><span class="n">dt_location</span><span class="p">[</span><span class="s1">&#39;latlong&#39;</span><span class="p">])</span>

<span class="c1"># ktree to find nearest users&#39;s planning area on telco train data </span>
<span class="n">query_idx</span> <span class="o">=</span> <span class="n">kdtree_neighbors</span><span class="p">(</span><span class="n">reference</span><span class="o">=</span><span class="n">latlong_users</span><span class="p">,</span> <span class="n">query_data</span><span class="o">=</span><span class="n">latlong_school</span><span class="p">)</span>
<span class="n">dt</span><span class="p">[</span><span class="s1">&#39;telco_schools&#39;</span><span class="p">][</span><span class="s1">&#39;planning_area&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">dt_location</span><span class="p">[</span><span class="s1">&#39;planning_area&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">query_idx</span><span class="p">]</span>
<span class="n">dt</span><span class="p">[</span><span class="s1">&#39;telco_schools&#39;</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>category</th>
      <th>name</th>
      <th>latLong</th>
      <th>planning_area</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Primary Schools</td>
      <td>Alexandra Primary</td>
      <td>"1.291298368, 103.8239405"</td>
      <td>BUKIT MERAH</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Primary Schools</td>
      <td>Gan Eng Seng Primary</td>
      <td>"1.2855944990000001, 103.8155471"</td>
      <td>BUKIT MERAH</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Primary Schools</td>
      <td>Zhangde Primary</td>
      <td>"1.284279434, 103.8261758"</td>
      <td>BUKIT MERAH</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Secondary Schools</td>
      <td>Crescent Girls</td>
      <td>"1.293318804, 103.8175441"</td>
      <td>QUEENSTOWN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Secondary Schools</td>
      <td>Gan Eng Seng</td>
      <td>"1.289070478, 103.8237333"</td>
      <td>BUKIT MERAH</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>368</th>
      <td>Primary Schools</td>
      <td>Pioneer Primary</td>
      <td>"1.348720261, 103.6948675"</td>
      <td>JURONG WEST</td>
    </tr>
    <tr>
      <th>369</th>
      <td>Primary Schools</td>
      <td>Qihua Primary</td>
      <td>"1.4420353, 103.7883394"</td>
      <td>WOODLANDS</td>
    </tr>
    <tr>
      <th>370</th>
      <td>Secondary Schools</td>
      <td>Riverside Secondary</td>
      <td>"1.441077283, 103.7883131"</td>
      <td>WOODLANDS</td>
    </tr>
    <tr>
      <th>371</th>
      <td>Secondary Schools</td>
      <td>Westwood Secondary</td>
      <td>"1.353736319, 103.7017718"</td>
      <td>JURONG WEST</td>
    </tr>
    <tr>
      <th>372</th>
      <td>Integrated Schools</td>
      <td>School Of The Arts Singapore</td>
      <td>"1.299364137, 103.8486871"</td>
      <td>ROCHOR</td>
    </tr>
  </tbody>
</table>
<p>373 rows  4 columns</p>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">planning_area_school</span> <span class="o">=</span> <span class="n">school_plan__features</span><span class="p">(</span><span class="n">dt</span><span class="p">[</span><span class="s1">&#39;telco_schools&#39;</span><span class="p">])</span>
<span class="n">planning_area_school</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">planning_area_school</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
<span class="n">planning_area_school</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>planning_area</th>
      <th>number_school</th>
      <th>integrated_schools</th>
      <th>primary_schools</th>
      <th>secondary_schools</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>ANG MO KIO</td>
      <td>17</td>
      <td>1.0</td>
      <td>8.0</td>
      <td>8.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>BEDOK</td>
      <td>24</td>
      <td>1.0</td>
      <td>12.0</td>
      <td>11.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>BISHAN</td>
      <td>15</td>
      <td>3.0</td>
      <td>4.0</td>
      <td>8.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>BUKIT BATOK</td>
      <td>11</td>
      <td>0.0</td>
      <td>6.0</td>
      <td>5.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>BUKIT MERAH</td>
      <td>13</td>
      <td>0.0</td>
      <td>8.0</td>
      <td>5.0</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">planning_area_school</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">((</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;Data&quot;</span><span class="p">,</span><span class="s2">&quot;L1&quot;</span><span class="p">,</span> <span class="s2">&quot;geo_school.pkl&quot;</span><span class="p">)))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="train">train<a class="anchor-link" href="#train"> </a></h1><p>reference_date - 2020-04-15</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>To acquire:</p>
<ul>
<li>mean/median lat and lng</li>
<li>number of users</li>
</ul>
<p>For each planning area</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">train_dt</span> <span class="o">=</span> <span class="n">dt</span><span class="p">[</span><span class="s1">&#39;telco_train&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">plan_area_latlng</span> <span class="o">=</span> <span class="n">train_plan__latlng</span><span class="p">(</span><span class="n">train_dt</span><span class="p">)</span> <span class="c1"># extracting numerical (lat,lng) from data</span>
<span class="n">plan_area_users_nb</span> <span class="o">=</span> <span class="n">train_plan__nbusers</span><span class="p">(</span><span class="n">train_dt</span><span class="p">)</span>
<span class="n">plan_area_dt</span> <span class="o">=</span> <span class="n">plan_area_latlng</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">plan_area_users_nb</span><span class="p">)</span>
<span class="n">plan_area_dt</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>planning_area</th>
      <th>lat</th>
      <th>lng</th>
      <th>users_nb</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>ANG MO KIO</td>
      <td>1.371236</td>
      <td>103.847778</td>
      <td>1012</td>
    </tr>
    <tr>
      <th>1</th>
      <td>BEDOK</td>
      <td>1.331222</td>
      <td>103.928134</td>
      <td>1479</td>
    </tr>
    <tr>
      <th>2</th>
      <td>BISHAN</td>
      <td>1.355431</td>
      <td>103.839107</td>
      <td>127</td>
    </tr>
    <tr>
      <th>3</th>
      <td>BUKIT BATOK</td>
      <td>1.351252</td>
      <td>103.750406</td>
      <td>1276</td>
    </tr>
    <tr>
      <th>4</th>
      <td>BUKIT MERAH</td>
      <td>1.279427</td>
      <td>103.822536</td>
      <td>429</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">plan_area_dt</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(30, 4)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">plan_area_dt</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">((</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;Data&quot;</span><span class="p">,</span><span class="s2">&quot;L1&quot;</span><span class="p">,</span> <span class="s2">&quot;geo_coor.pkl&quot;</span><span class="p">)))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="user-train">user train<a class="anchor-link" href="#user-train"> </a></h2><p>To prepare for modeling later on, categories fields are modified.</p>
<ul>
<li><strong>churn</strong> - 1(churned), 0(no)</li>
<li><strong>contract</strong> - yearly :1, monthly:0</li>
<li><strong>internet_service</strong> - fiber :1, no:0</li>
</ul>
<p>some time based features (based on contracts- when does it starts, how long has it been going) are also generated</p>
<ul>
<li><strong>account_start_year</strong> - how long are these users with the telco</li>
<li><strong>month_delta</strong> - how many months are they from the contract start (ref date - contract date)</li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">train_time_features</span><span class="p">(</span><span class="n">train_dt</span><span class="p">)</span>

<span class="n">train_dt</span> <span class="o">=</span> <span class="n">train_dt</span><span class="p">[[</span><span class="s1">&#39;msisdn&#39;</span><span class="p">,</span> <span class="s1">&#39;churn&#39;</span><span class="p">,</span> <span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s1">&#39;contract&#39;</span><span class="p">,</span>
       <span class="s1">&#39;internet_service&#39;</span><span class="p">,</span> <span class="s1">&#39;account_start_year&#39;</span><span class="p">,</span><span class="s1">&#39;planning_area&#39;</span><span class="p">,</span> <span class="s1">&#39;month_delta&#39;</span><span class="p">]]</span>
<span class="c1"># dropping some columns that would not make a lot of sense in this case</span>
<span class="c1"># &#39;address&#39;,&#39;name&#39;, &#39;birthday&#39;, &#39;account_start_date&#39;, &#39;reference_date&#39;,&#39;gender&#39;</span>

<span class="n">train_dt</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;churn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_dt</span><span class="p">[</span><span class="s1">&#39;churn&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">contract_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;monthly&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;two-year&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>
<span class="n">train_dt</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;contract&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_dt</span><span class="p">[</span><span class="s1">&#39;contract&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">contract_dict</span><span class="p">)</span>
<span class="n">internet_service</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fiber&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;no&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span>
<span class="n">train_dt</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;internet_service&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_dt</span><span class="p">[</span><span class="s1">&#39;internet_service&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">internet_service</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">train_dt</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>msisdn</th>
      <th>churn</th>
      <th>age</th>
      <th>contract</th>
      <th>internet_service</th>
      <th>account_start_year</th>
      <th>planning_area</th>
      <th>month_delta</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>6048764759382</td>
      <td>0</td>
      <td>44</td>
      <td>0</td>
      <td>1</td>
      <td>2018</td>
      <td>TOA PAYOH</td>
      <td>25</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1948924115781</td>
      <td>0</td>
      <td>21</td>
      <td>1</td>
      <td>1</td>
      <td>2016</td>
      <td>GEYLANG</td>
      <td>45</td>
    </tr>
    <tr>
      <th>2</th>
      <td>5938778408016</td>
      <td>0</td>
      <td>57</td>
      <td>0</td>
      <td>1</td>
      <td>2018</td>
      <td>JURONG WEST</td>
      <td>16</td>
    </tr>
    <tr>
      <th>3</th>
      <td>975351393328</td>
      <td>0</td>
      <td>49</td>
      <td>1</td>
      <td>0</td>
      <td>2014</td>
      <td>BEDOK</td>
      <td>72</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1587148418583</td>
      <td>0</td>
      <td>24</td>
      <td>0</td>
      <td>0</td>
      <td>2011</td>
      <td>BEDOK</td>
      <td>101</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">train_dt</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">((</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;Data&quot;</span><span class="p">,</span><span class="s2">&quot;L1&quot;</span><span class="p">,</span> <span class="s2">&quot;user_train.pkl&quot;</span><span class="p">)))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="geo-train">geo train<a class="anchor-link" href="#geo-train"> </a></h2><p>Converting the train data to geography level,since some trends/features would be better measured at geo level.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">geo_train</span> <span class="o">=</span> <span class="n">train_dt</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;planning_area&#39;</span><span class="p">)[[</span><span class="s1">&#39;age&#39;</span><span class="p">,</span><span class="s1">&#39;contract&#39;</span><span class="p">,</span><span class="s1">&#39;internet_service&#39;</span><span class="p">,</span><span class="s1">&#39;account_start_year&#39;</span><span class="p">,</span><span class="s1">&#39;month_delta&#39;</span><span class="p">,</span><span class="s1">&#39;churn&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">geo_train</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>planning_area</th>
      <th>age</th>
      <th>contract</th>
      <th>internet_service</th>
      <th>account_start_year</th>
      <th>month_delta</th>
      <th>churn</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>ANG MO KIO</td>
      <td>38.967391</td>
      <td>0.531621</td>
      <td>0.443676</td>
      <td>2014.265810</td>
      <td>65.870553</td>
      <td>0.093874</td>
    </tr>
    <tr>
      <th>1</th>
      <td>BEDOK</td>
      <td>39.557133</td>
      <td>0.555105</td>
      <td>0.465855</td>
      <td>2014.260987</td>
      <td>65.876944</td>
      <td>0.077755</td>
    </tr>
    <tr>
      <th>2</th>
      <td>BISHAN</td>
      <td>38.417323</td>
      <td>0.511811</td>
      <td>0.527559</td>
      <td>2014.070866</td>
      <td>67.992126</td>
      <td>0.196850</td>
    </tr>
    <tr>
      <th>3</th>
      <td>BUKIT BATOK</td>
      <td>40.536050</td>
      <td>0.530564</td>
      <td>0.472571</td>
      <td>2014.325235</td>
      <td>65.303292</td>
      <td>0.063480</td>
    </tr>
    <tr>
      <th>4</th>
      <td>BUKIT MERAH</td>
      <td>39.228438</td>
      <td>0.543124</td>
      <td>0.510490</td>
      <td>2014.235431</td>
      <td>66.386946</td>
      <td>0.118881</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">geo_train</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;Data&quot;</span><span class="p">,</span><span class="s2">&quot;L1&quot;</span><span class="p">,</span> <span class="s2">&quot;geo_train.pkl&quot;</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="locations">locations<a class="anchor-link" href="#locations"> </a></h1>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>printing sample data of locations (top 10 visiits location for users)</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">cur_dt</span> <span class="o">=</span> <span class="n">dt</span><span class="p">[</span><span class="s1">&#39;telco_locations&#39;</span><span class="p">]</span>
<span class="n">cur_dt</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>latitude</th>
      <th>longitude</th>
      <th>msisdn</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1.326087</td>
      <td>103.898460</td>
      <td>6048764759382</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1.301823</td>
      <td>103.904991</td>
      <td>1948924115781</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1.301894</td>
      <td>103.904761</td>
      <td>5938778408016</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1.334966</td>
      <td>103.745927</td>
      <td>975351393328</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1.291109</td>
      <td>103.812621</td>
      <td>1587148418583</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>assigne the lat long to a planning area based on the avilable user data</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">latlong_loc</span> <span class="o">=</span>  <span class="p">[(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">y</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">cur_dt</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">],</span><span class="n">cur_dt</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">])]</span>

<span class="c1"># generating unique lat long - planning area data based on users that is used for references mapping</span>
<span class="n">dt_location</span> <span class="o">=</span> <span class="n">dt</span><span class="p">[</span><span class="s1">&#39;telco_train&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;latlong&#39;</span><span class="p">,</span><span class="s1">&#39;planning_area&#39;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s1">&#39;msisdn&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
<span class="n">latlong_users</span> <span class="o">=</span>  <span class="n">translate_latlng</span><span class="p">(</span><span class="n">dt_location</span><span class="p">[</span><span class="s1">&#39;latlong&#39;</span><span class="p">])</span>

<span class="c1"># ktree to find nearest users&#39;s planning area on telco train data </span>
<span class="n">query_idx</span> <span class="o">=</span> <span class="n">kdtree_neighbors</span><span class="p">(</span><span class="n">reference</span><span class="o">=</span><span class="n">latlong_users</span><span class="p">,</span> <span class="n">query_data</span><span class="o">=</span><span class="n">latlong_loc</span><span class="p">)</span>
<span class="n">dt</span><span class="p">[</span><span class="s1">&#39;telco_locations&#39;</span><span class="p">][</span><span class="s1">&#39;planning_area&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">dt_location</span><span class="p">[</span><span class="s1">&#39;planning_area&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">query_idx</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="geo-location">geo location<a class="anchor-link" href="#geo-location"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dt</span><span class="p">[</span><span class="s1">&#39;telco_locations&#39;</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>latitude</th>
      <th>longitude</th>
      <th>msisdn</th>
      <th>planning_area</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1.326087</td>
      <td>103.898460</td>
      <td>6048764759382</td>
      <td>GEYLANG</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1.301823</td>
      <td>103.904991</td>
      <td>1948924115781</td>
      <td>MARINE PARADE</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1.301894</td>
      <td>103.904761</td>
      <td>5938778408016</td>
      <td>MARINE PARADE</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1.334966</td>
      <td>103.745927</td>
      <td>975351393328</td>
      <td>JURONG EAST</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1.291109</td>
      <td>103.812621</td>
      <td>1587148418583</td>
      <td>QUEENSTOWN</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>29995</th>
      <td>1.300675</td>
      <td>103.838027</td>
      <td>197681231203</td>
      <td>BUKIT MERAH</td>
    </tr>
    <tr>
      <th>29996</th>
      <td>1.301725</td>
      <td>103.904361</td>
      <td>6183326134523</td>
      <td>MARINE PARADE</td>
    </tr>
    <tr>
      <th>29997</th>
      <td>1.356236</td>
      <td>103.990446</td>
      <td>9770826000249</td>
      <td>TAMPINES</td>
    </tr>
    <tr>
      <th>29998</th>
      <td>1.309874</td>
      <td>103.901078</td>
      <td>5855470225901</td>
      <td>GEYLANG</td>
    </tr>
    <tr>
      <th>29999</th>
      <td>1.286921</td>
      <td>103.805714</td>
      <td>828522570419</td>
      <td>BUKIT MERAH</td>
    </tr>
  </tbody>
</table>
<p>30000 rows  4 columns</p>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dt</span><span class="p">[</span><span class="s1">&#39;telco_locations&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;Data&quot;</span><span class="p">,</span><span class="s2">&quot;L1&quot;</span><span class="p">,</span> <span class="s2">&quot;geo_location.pkl&quot;</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="users-location">users location<a class="anchor-link" href="#users-location"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">user_loc</span> <span class="o">=</span> <span class="n">dt</span><span class="p">[</span><span class="s1">&#39;telco_locations&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">user_loc</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;planning_area&#39;</span><span class="p">)</span>
<span class="n">user_loc</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
<span class="n">user_loc</span> <span class="o">=</span> <span class="n">user_loc</span><span class="p">[[</span><span class="s1">&#39;msisdn&#39;</span><span class="p">,</span><span class="s1">&#39;planning_area&#39;</span><span class="p">,</span><span class="s1">&#39;value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;msisdn&#39;</span><span class="p">],</span> <span class="n">columns</span> <span class="o">=</span> <span class="s1">&#39;planning_area&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tmp_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">if</span> <span class="n">y</span><span class="o">==</span><span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="n">y</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">user_loc</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">user_loc</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">1</span><span class="p">))]</span>
<span class="c1"># applying manipulated columns</span>
<span class="n">user_loc</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">tmp_columns</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">user_loc</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>msisdn</th>
      <th>ang mo kio</th>
      <th>bedok</th>
      <th>bishan</th>
      <th>bukit batok</th>
      <th>bukit merah</th>
      <th>bukit timah</th>
      <th>changi</th>
      <th>clementi</th>
      <th>geylang</th>
      <th>...</th>
      <th>marine parade</th>
      <th>novena</th>
      <th>outram</th>
      <th>pasir ris</th>
      <th>queenstown</th>
      <th>rochor</th>
      <th>serangoon</th>
      <th>tampines</th>
      <th>tanglin</th>
      <th>toa payoh</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>351144701</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1041740389</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1529121439</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2189894234</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2504021639</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>...</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
<p>5 rows  24 columns</p>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>this might be too spare for usage with users data and may require additional processing...</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">user_loc</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;Data&quot;</span><span class="p">,</span><span class="s2">&quot;L1&quot;</span><span class="p">,</span> <span class="s2">&quot;user_location.pkl&quot;</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="census">census<a class="anchor-link" href="#census"> </a></h1><p>condensing the features into</p>
<ul>
<li><strong>med_income</strong></li>
<li><strong>avg_income</strong></li>
<li><strong>gini_coef</strong></li>
<li><strong>pop</strong></li>
<li><strong>working_pop</strong></li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">census_dt</span> <span class="o">=</span> <span class="n">dt</span><span class="p">[</span><span class="s1">&#39;telco_census&#39;</span><span class="p">]</span>
<span class="n">census_dt</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>planning_area</th>
      <th>total</th>
      <th>below_sgd_1000</th>
      <th>no_working_person</th>
      <th>sgd_10000_over</th>
      <th>sgd_1000_to_1999</th>
      <th>sgd_2000_to_2999</th>
      <th>sgd_3000_to_3999</th>
      <th>sgd_4000_to_4999</th>
      <th>sgd_5000_to_5999</th>
      <th>...</th>
      <th>sgd_10000_over_percent</th>
      <th>sgd_1000_to_1999_percent</th>
      <th>sgd_2000_to_2999_percent</th>
      <th>sgd_3000_to_3999_percent</th>
      <th>sgd_4000_to_4999_percent</th>
      <th>sgd_5000_to_5999_percent</th>
      <th>sgd_6000_to_6999_percent</th>
      <th>sgd_7000_to_7999_percent</th>
      <th>sgd_8000_to_8999_percent</th>
      <th>sgd_9000_to_9999_percent</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>ANG MO KIO</td>
      <td>59705</td>
      <td>3136</td>
      <td>8467</td>
      <td>12137</td>
      <td>5549</td>
      <td>6055</td>
      <td>5236</td>
      <td>4565</td>
      <td>3959</td>
      <td>...</td>
      <td>20.328281</td>
      <td>9.294029</td>
      <td>10.141529</td>
      <td>8.769785</td>
      <td>7.645926</td>
      <td>6.630935</td>
      <td>5.622645</td>
      <td>4.875639</td>
      <td>4.090110</td>
      <td>3.167239</td>
    </tr>
    <tr>
      <th>1</th>
      <td>BEDOK</td>
      <td>91224</td>
      <td>3782</td>
      <td>11143</td>
      <td>25281</td>
      <td>6857</td>
      <td>7476</td>
      <td>7362</td>
      <td>6596</td>
      <td>5825</td>
      <td>...</td>
      <td>27.713102</td>
      <td>7.516662</td>
      <td>8.195212</td>
      <td>8.070245</td>
      <td>7.230553</td>
      <td>6.385381</td>
      <td>5.967728</td>
      <td>4.770674</td>
      <td>4.173244</td>
      <td>3.615277</td>
    </tr>
    <tr>
      <th>2</th>
      <td>BISHAN</td>
      <td>27457</td>
      <td>595</td>
      <td>2855</td>
      <td>10264</td>
      <td>1166</td>
      <td>1390</td>
      <td>1717</td>
      <td>1616</td>
      <td>1594</td>
      <td>...</td>
      <td>37.382088</td>
      <td>4.246640</td>
      <td>5.062461</td>
      <td>6.253414</td>
      <td>5.885567</td>
      <td>5.805441</td>
      <td>6.133226</td>
      <td>5.907419</td>
      <td>5.026041</td>
      <td>5.728958</td>
    </tr>
    <tr>
      <th>3</th>
      <td>BUKIT BATOK</td>
      <td>44133</td>
      <td>1136</td>
      <td>3452</td>
      <td>13088</td>
      <td>2849</td>
      <td>3486</td>
      <td>3723</td>
      <td>3537</td>
      <td>3264</td>
      <td>...</td>
      <td>29.655813</td>
      <td>6.455487</td>
      <td>7.898851</td>
      <td>8.435864</td>
      <td>8.014411</td>
      <td>7.395826</td>
      <td>6.852015</td>
      <td>5.619378</td>
      <td>4.921487</td>
      <td>4.355018</td>
    </tr>
    <tr>
      <th>4</th>
      <td>BUKIT MERAH</td>
      <td>55627</td>
      <td>4142</td>
      <td>10311</td>
      <td>10685</td>
      <td>5324</td>
      <td>4495</td>
      <td>3767</td>
      <td>3679</td>
      <td>3602</td>
      <td>...</td>
      <td>19.208298</td>
      <td>9.570892</td>
      <td>8.080608</td>
      <td>6.771891</td>
      <td>6.613695</td>
      <td>6.475273</td>
      <td>5.245654</td>
      <td>4.589498</td>
      <td>4.210186</td>
      <td>3.252018</td>
    </tr>
  </tbody>
</table>
<p>5 rows  26 columns</p>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">## columns control</span>
<span class="n">index_col</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;planning_area&#39;</span><span class="p">]</span>
<span class="n">perc_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">census_dt</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">index_col</span> <span class="ow">or</span> <span class="s1">&#39;percent&#39;</span> <span class="ow">in</span> <span class="n">i</span><span class="p">]</span>
<span class="c1">## subset of dt</span>
<span class="n">census_perc_dt</span> <span class="o">=</span> <span class="n">census_dt</span><span class="p">[</span><span class="n">perc_columns</span><span class="p">]</span>
<span class="c1">## gini</span>
<span class="n">census_perc_dt_melt</span> <span class="o">=</span> <span class="n">census_perc_dt</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="s1">&#39;planning_area&#39;</span><span class="p">)</span>
<span class="n">census_gini_dt</span> <span class="o">=</span> <span class="n">gini_processing</span><span class="p">(</span><span class="n">census_perc_dt_melt</span><span class="p">)</span>

<span class="c1"># income avg and med calculation</span>
<span class="c1">## subset of dt</span>
<span class="n">census_income_dt</span> <span class="o">=</span> <span class="n">census_dt</span><span class="p">[[</span><span class="s1">&#39;planning_area&#39;</span><span class="p">,</span> <span class="s1">&#39;below_sgd_1000&#39;</span><span class="p">,</span> <span class="s1">&#39;no_working_person&#39;</span><span class="p">,</span>
       <span class="s1">&#39;sgd_10000_over&#39;</span><span class="p">,</span> <span class="s1">&#39;sgd_1000_to_1999&#39;</span><span class="p">,</span> <span class="s1">&#39;sgd_2000_to_2999&#39;</span><span class="p">,</span>
       <span class="s1">&#39;sgd_3000_to_3999&#39;</span><span class="p">,</span> <span class="s1">&#39;sgd_4000_to_4999&#39;</span><span class="p">,</span> <span class="s1">&#39;sgd_5000_to_5999&#39;</span><span class="p">,</span>
       <span class="s1">&#39;sgd_6000_to_6999&#39;</span><span class="p">,</span> <span class="s1">&#39;sgd_7000_to_7999&#39;</span><span class="p">,</span> <span class="s1">&#39;sgd_8000_to_8999&#39;</span><span class="p">,</span>
       <span class="s1">&#39;sgd_9000_to_9999&#39;</span><span class="p">]]</span>
<span class="n">census_income_dt_melt</span> <span class="o">=</span> <span class="n">census_income_dt</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="s1">&#39;planning_area&#39;</span><span class="p">)</span>
<span class="n">income_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;no_working_person&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> 
 <span class="s1">&#39;below_sgd_1000&#39;</span><span class="p">:</span><span class="mi">500</span><span class="p">,</span>
 <span class="s1">&#39;sgd_10000_over&#39;</span><span class="p">:</span><span class="mi">12000</span><span class="p">,</span> 
 <span class="s1">&#39;sgd_1000_to_1999&#39;</span><span class="p">:</span><span class="mi">1500</span><span class="p">,</span> 
 <span class="s1">&#39;sgd_2000_to_2999&#39;</span><span class="p">:</span><span class="mi">2500</span><span class="p">,</span>
 <span class="s1">&#39;sgd_3000_to_3999&#39;</span><span class="p">:</span><span class="mi">3500</span><span class="p">,</span> 
 <span class="s1">&#39;sgd_4000_to_4999&#39;</span><span class="p">:</span><span class="mi">4500</span><span class="p">,</span> 
 <span class="s1">&#39;sgd_5000_to_5999&#39;</span><span class="p">:</span><span class="mi">5500</span><span class="p">,</span>
 <span class="s1">&#39;sgd_6000_to_6999&#39;</span><span class="p">:</span><span class="mi">6500</span><span class="p">,</span> 
 <span class="s1">&#39;sgd_7000_to_7999&#39;</span><span class="p">:</span><span class="mi">7500</span><span class="p">,</span> 
 <span class="s1">&#39;sgd_8000_to_8999&#39;</span><span class="p">:</span><span class="mi">8500</span><span class="p">,</span>
 <span class="s1">&#39;sgd_9000_to_9999&#39;</span><span class="p">:</span><span class="mi">9500</span><span class="p">}</span>
<span class="n">census_income_dt_melt</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">census_income_dt_melt</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">income_dict</span><span class="p">)</span>
<span class="n">census_income_median_dt</span> <span class="o">=</span> <span class="n">census_income_median</span><span class="p">(</span><span class="n">census_income_dt_melt</span><span class="p">)</span>
<span class="n">census_income_average_dt</span> <span class="o">=</span> <span class="n">census_income_avg</span><span class="p">(</span><span class="n">census_income_dt_melt</span><span class="p">)</span>

<span class="c1"># raw data</span>
<span class="n">census_total_dt</span> <span class="o">=</span> <span class="n">census_dt</span><span class="p">[[</span><span class="s1">&#39;planning_area&#39;</span><span class="p">,</span><span class="s1">&#39;total&#39;</span><span class="p">,</span><span class="s1">&#39;no_working_person&#39;</span><span class="p">]]</span>
<span class="c1"># combining all the calculated income features</span>
<span class="n">census_concat_dt</span> <span class="o">=</span> <span class="p">(</span><span class="n">census_income_median_dt</span>
                    <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">census_income_average_dt</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">census_gini_dt</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">census_total_dt</span><span class="p">)</span>
                   <span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;total&#39;</span><span class="p">:</span><span class="s1">&#39;pop&#39;</span><span class="p">},</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">census_concat_dt</span><span class="p">[</span><span class="s1">&#39;working_pop&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">census_concat_dt</span><span class="p">[</span><span class="s1">&#39;pop&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">census_concat_dt</span><span class="p">[</span><span class="s1">&#39;no_working_person&#39;</span><span class="p">]</span>
<span class="n">census_concat_dt</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;no_working_person&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">census_concat_dt</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>planning_area</th>
      <th>med_income</th>
      <th>avg_income</th>
      <th>gini_coef</th>
      <th>pop</th>
      <th>working_pop</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>JURONG WEST</td>
      <td>3500</td>
      <td>6000.685168</td>
      <td>0.336021</td>
      <td>78083</td>
      <td>72683</td>
    </tr>
    <tr>
      <th>1</th>
      <td>BEDOK</td>
      <td>2500</td>
      <td>6066.907469</td>
      <td>0.383530</td>
      <td>91224</td>
      <td>80081</td>
    </tr>
    <tr>
      <th>2</th>
      <td>WOODLANDS</td>
      <td>4500</td>
      <td>5892.433984</td>
      <td>0.336238</td>
      <td>68279</td>
      <td>64030</td>
    </tr>
    <tr>
      <th>3</th>
      <td>TAMPINES</td>
      <td>3500</td>
      <td>6456.678897</td>
      <td>0.323235</td>
      <td>73591</td>
      <td>68297</td>
    </tr>
    <tr>
      <th>4</th>
      <td>ANG MO KIO</td>
      <td>2500</td>
      <td>5254.007202</td>
      <td>0.427458</td>
      <td>59705</td>
      <td>51238</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">census_concat_dt</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">((</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;Data&quot;</span><span class="p">,</span><span class="s2">&quot;L1&quot;</span><span class="p">,</span> <span class="s2">&quot;geo_census.pkl&quot;</span><span class="p">)))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="reviews">reviews<a class="anchor-link" href="#reviews"> </a></h1><p>Overtime data (monthly per user) for 6 months.</p>
<ul>
<li>used hugging face (pretrained bert) to run a sentimental analysis</li>
<li>assigned positive to 1, neutral to 0.5, negative to 0</li>
<li>generate time series features via tsfresh</li>
<li>significant test with churns.</li>
</ul>
<p>This takes significant amount of time to run on CPU (as well as lots of dependency), seeing that there is no significant trends identified with the current pipeline, it should perhaps be commented out on normal runs</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">reviews_dt</span> <span class="o">=</span> <span class="n">dt</span><span class="p">[</span><span class="s1">&#39;telco_reviews&#39;</span><span class="p">]</span>
<span class="n">reviews_dt</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>msisdn</th>
      <th>date</th>
      <th>feedback</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>6048764759382</td>
      <td>2019-10-31</td>
      <td>Detailed bluetooth weighted component biotechn...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1948924115781</td>
      <td>2019-10-31</td>
      <td>Functionality plenty clients magical baghdad s...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>5938778408016</td>
      <td>2019-10-31</td>
      <td>Imports rj mardi henry mm ones optical laptops...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>975351393328</td>
      <td>2019-10-31</td>
      <td>Stephen eminem valued evidence prescription si...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1587148418583</td>
      <td>2019-10-31</td>
      <td>Cap designated choose entertainment discussion...</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">n</span><span class="o">=</span><span class="mi">0</span>
<span class="n">n_top</span><span class="o">=</span><span class="mi">0</span>
<span class="n">sent_list</span><span class="o">=</span><span class="p">[]</span>
<span class="k">while</span> <span class="n">n_top</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">reviews_dt</span><span class="p">):</span>
    <span class="n">n_top</span><span class="o">+=</span><span class="mi">1000</span>
    <span class="n">sent_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">census_sentiment_analy</span><span class="p">(</span><span class="n">reviews_dt</span><span class="p">[</span><span class="s1">&#39;feedback&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="n">n</span><span class="p">:</span><span class="n">n_top</span><span class="p">]))</span>
    <span class="n">n</span><span class="o">+=</span><span class="mi">1000</span>

<span class="c1"># flattening the list</span>
<span class="n">flat_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">sent_list</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>
<span class="n">reviews_dt</span><span class="p">[</span><span class="s1">&#39;sentimental_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">convert_sent2score</span><span class="p">(</span><span class="n">flat_list</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">reviews_dt</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>msisdn</th>
      <th>date</th>
      <th>feedback</th>
      <th>sentimental_score</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>6048764759382</td>
      <td>2019-10-31</td>
      <td>Detailed bluetooth weighted component biotechn...</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1948924115781</td>
      <td>2019-10-31</td>
      <td>Functionality plenty clients magical baghdad s...</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>5938778408016</td>
      <td>2019-10-31</td>
      <td>Imports rj mardi henry mm ones optical laptops...</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>975351393328</td>
      <td>2019-10-31</td>
      <td>Stephen eminem valued evidence prescription si...</td>
      <td>0.5</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1587148418583</td>
      <td>2019-10-31</td>
      <td>Cap designated choose entertainment discussion...</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">reviews_sub_dt</span> <span class="o">=</span> <span class="n">reviews_dt</span><span class="p">[[</span><span class="s1">&#39;msisdn&#39;</span><span class="p">,</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="s1">&#39;sentimental_score&#39;</span><span class="p">]]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">reviews_sub_dt</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">((</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;Data&quot;</span><span class="p">,</span><span class="s2">&quot;L1&quot;</span><span class="p">,</span> <span class="s2">&quot;user_senti_score_OT.pkl&quot;</span><span class="p">)))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">features_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;maximum&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;minimum&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;absolute_sum_of_changes&quot;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span>
                 <span class="s2">&quot;benford_correlation&quot;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;mean_change&quot;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;sum_values&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;linear_trend&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;attr&#39;</span><span class="p">:</span> <span class="s1">&#39;slope&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;attr&#39;</span><span class="p">:</span> <span class="s1">&#39;intercept&#39;</span><span class="p">}],</span> 
                <span class="p">}</span>
<span class="n">kind_to_fc_parameters</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;sentimental_score&quot;</span><span class="p">:</span> <span class="n">features_dict</span>
<span class="p">}</span>
<span class="c1"># calc all the ts features</span>
<span class="n">extracted_features_dt</span> <span class="o">=</span> <span class="n">extract_features</span><span class="p">(</span><span class="n">reviews_sub_dt</span><span class="p">,</span> <span class="n">column_id</span> <span class="o">=</span> <span class="s2">&quot;msisdn&quot;</span><span class="p">,</span> <span class="n">column_sort</span> <span class="o">=</span> <span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="n">kind_to_fc_parameters</span> <span class="o">=</span> <span class="n">kind_to_fc_parameters</span><span class="p">)</span>

<span class="c1"># dropping na records</span>
<span class="n">extracted_features_dt</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># generating index for churn for significant check</span>
<span class="n">churn_dt</span> <span class="o">=</span> <span class="n">transform_churn_series</span><span class="p">(</span><span class="n">extracted_features_dt</span> <span class="o">=</span> <span class="n">extracted_features_dt</span><span class="p">,</span> <span class="n">dt_churn</span> <span class="o">=</span> <span class="n">dt</span><span class="p">[</span><span class="s1">&#39;telco_train&#39;</span><span class="p">])</span>

<span class="c1"># significant test and retain only relevent features</span>
<span class="n">relevance_dt</span> <span class="o">=</span> <span class="n">calculate_relevance_table</span><span class="p">(</span><span class="n">extracted_features_dt</span><span class="p">,</span> <span class="n">churn_dt</span><span class="p">[</span><span class="s1">&#39;churn&#39;</span><span class="p">],</span> <span class="n">ml_task</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">sig_columns</span> <span class="o">=</span> <span class="n">relevance_dt</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">relevance_dt</span><span class="p">[</span><span class="s1">&#39;relevant&#39;</span><span class="p">]</span><span class="o">==</span><span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;feature&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">extracted_sig_features_dt</span> <span class="o">=</span> <span class="n">extracted_features_dt</span><span class="p">[</span><span class="n">sig_columns</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Feature Extraction: 100%|| 30/30 [00:11&lt;00:00,  2.65it/s]
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tsfresh</span><span class="o">.</span><span class="n">feature_extraction</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">from_columns</span><span class="p">(</span><span class="n">extracted_features_dt</span><span class="p">[</span><span class="n">sig_columns</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{}</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;number of sig features: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">extracted_sig_features_dt</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>number of sig features: 0
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>sadly, it seems the sentimental scores time series trends has little to no impact to the churns (None of the features manage to pass the significant testing in tsfresh).....</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="cdr">cdr<a class="anchor-link" href="#cdr"> </a></h1><p>Overtime CDR data (monthly per user) for 6 months.</p>
<ul>
<li>generate time series features via tsfresh</li>
<li>significant test with churns.</li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">cdr_dt</span> <span class="o">=</span> <span class="n">dt</span><span class="p">[</span><span class="s1">&#39;telco_cdr&#39;</span><span class="p">]</span>
<span class="c1"># printing cdr of a single user</span>
<span class="n">cdr_dt</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cdr_dt</span><span class="p">[</span><span class="s1">&#39;msisdn&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">351144701</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>msisdn</th>
      <th>date</th>
      <th>voice_incoming</th>
      <th>voice_outgoing</th>
      <th>sms_incoming</th>
      <th>sms_outgoing</th>
      <th>data_upload</th>
      <th>data_download</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>407</th>
      <td>351144701</td>
      <td>2019-10-31</td>
      <td>52</td>
      <td>28</td>
      <td>79</td>
      <td>11</td>
      <td>1176</td>
      <td>2374</td>
    </tr>
    <tr>
      <th>15407</th>
      <td>351144701</td>
      <td>2019-11-30</td>
      <td>59</td>
      <td>34</td>
      <td>68</td>
      <td>12</td>
      <td>1276</td>
      <td>2522</td>
    </tr>
    <tr>
      <th>30407</th>
      <td>351144701</td>
      <td>2019-12-31</td>
      <td>49</td>
      <td>30</td>
      <td>60</td>
      <td>8</td>
      <td>1218</td>
      <td>3186</td>
    </tr>
    <tr>
      <th>45407</th>
      <td>351144701</td>
      <td>2020-01-31</td>
      <td>64</td>
      <td>33</td>
      <td>57</td>
      <td>7</td>
      <td>1283</td>
      <td>2517</td>
    </tr>
    <tr>
      <th>60407</th>
      <td>351144701</td>
      <td>2020-02-29</td>
      <td>83</td>
      <td>33</td>
      <td>59</td>
      <td>5</td>
      <td>1047</td>
      <td>3171</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">features_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;maximum&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;minimum&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;absolute_sum_of_changes&quot;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span>
                 <span class="s2">&quot;benford_correlation&quot;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;mean_change&quot;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;longest_strike_above_mean&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span>
                 <span class="s1">&#39;longest_strike_below_mean&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;sum_values&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;linear_trend&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;attr&#39;</span><span class="p">:</span> <span class="s1">&#39;slope&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;attr&#39;</span><span class="p">:</span> <span class="s1">&#39;intercept&#39;</span><span class="p">}],</span> 
                <span class="p">}</span>
<span class="n">kind_to_fc_parameters</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;voice_incoming&quot;</span><span class="p">:</span> <span class="n">features_dict</span><span class="p">,</span>
    <span class="s2">&quot;voice_outgoing&quot;</span><span class="p">:</span> <span class="n">features_dict</span><span class="p">,</span> 
    <span class="s2">&quot;sms_incoming&quot;</span><span class="p">:</span> <span class="n">features_dict</span><span class="p">,</span> 
    <span class="s2">&quot;sms_outgoing&quot;</span><span class="p">:</span> <span class="n">features_dict</span><span class="p">,</span>
    <span class="s2">&quot;data_upload&quot;</span><span class="p">:</span> <span class="n">features_dict</span><span class="p">,</span>
    <span class="s2">&quot;data_download&quot;</span><span class="p">:</span> <span class="n">features_dict</span><span class="p">,</span> 
<span class="p">}</span>
<span class="c1"># calc all the ts features</span>
<span class="n">extracted_features_dt</span> <span class="o">=</span> <span class="n">extract_features</span><span class="p">(</span><span class="n">cdr_dt</span><span class="p">,</span> <span class="n">column_id</span><span class="o">=</span><span class="s2">&quot;msisdn&quot;</span><span class="p">,</span> <span class="n">column_sort</span><span class="o">=</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="n">kind_to_fc_parameters</span> <span class="o">=</span> <span class="n">kind_to_fc_parameters</span><span class="p">)</span>

<span class="c1"># dropping na records</span>
<span class="n">extracted_features_dt</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># generating index for churn for significant check</span>
<span class="n">churn_dt</span> <span class="o">=</span> <span class="n">transform_churn_series</span><span class="p">(</span><span class="n">extracted_features_dt</span><span class="o">=</span> <span class="n">extracted_features_dt</span><span class="p">,</span> <span class="n">dt_churn</span> <span class="o">=</span> <span class="n">dt</span><span class="p">[</span><span class="s1">&#39;telco_train&#39;</span><span class="p">])</span>

<span class="c1"># significant test and retain only relevent features</span>
<span class="n">relevance_dt</span> <span class="o">=</span> <span class="n">calculate_relevance_table</span><span class="p">(</span><span class="n">extracted_features_dt</span><span class="p">,</span> <span class="n">churn_dt</span><span class="p">[</span><span class="s1">&#39;churn&#39;</span><span class="p">],</span> <span class="n">ml_task</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">sig_columns</span> <span class="o">=</span> <span class="n">relevance_dt</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">relevance_dt</span><span class="p">[</span><span class="s1">&#39;relevant&#39;</span><span class="p">]</span><span class="o">==</span><span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;feature&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">extracted_sig_features_dt</span> <span class="o">=</span> <span class="n">extracted_features_dt</span><span class="p">[</span><span class="n">sig_columns</span><span class="p">]</span>

<span class="c1"># settings</span>
<span class="n">tsfresh</span><span class="o">.</span><span class="n">feature_extraction</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">from_columns</span><span class="p">(</span><span class="n">extracted_features_dt</span><span class="p">[</span><span class="n">sig_columns</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Feature Extraction: 100%|| 30/30 [00:27&lt;00:00,  1.09it/s]
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{&#39;data_download&#39;: {&#39;mean_change&#39;: None,
  &#39;linear_trend&#39;: [{&#39;attr&#39;: &#39;slope&#39;}],
  &#39;absolute_sum_of_changes&#39;: None,
  &#39;maximum&#39;: None,
  &#39;sum_values&#39;: None,
  &#39;mean&#39;: None,
  &#39;minimum&#39;: None},
 &#39;voice_outgoing&#39;: {&#39;mean_change&#39;: None, &#39;linear_trend&#39;: [{&#39;attr&#39;: &#39;slope&#39;}]}}</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">extracted_sig_features_dt</span> <span class="o">=</span> <span class="n">extracted_sig_features_dt</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;index&#39;</span><span class="p">:</span><span class="s1">&#39;msisdn&#39;</span><span class="p">},</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">extracted_sig_features_dt</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>msisdn</th>
      <th>data_download__mean_change</th>
      <th>data_download__linear_trend__attr_"slope"</th>
      <th>voice_outgoing__mean_change</th>
      <th>voice_outgoing__linear_trend__attr_"slope"</th>
      <th>data_download__absolute_sum_of_changes</th>
      <th>data_download__maximum</th>
      <th>data_download__sum_values</th>
      <th>data_download__mean</th>
      <th>data_download__minimum</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>351144701</td>
      <td>124.0</td>
      <td>125.085714</td>
      <td>1.0</td>
      <td>0.714286</td>
      <td>2312.0</td>
      <td>3186.0</td>
      <td>16764.0</td>
      <td>2794.000000</td>
      <td>2374.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1041740389</td>
      <td>477.2</td>
      <td>447.028571</td>
      <td>-0.2</td>
      <td>-0.542857</td>
      <td>2386.0</td>
      <td>3977.0</td>
      <td>17152.0</td>
      <td>2858.666667</td>
      <td>1591.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1529121439</td>
      <td>157.8</td>
      <td>182.485714</td>
      <td>0.0</td>
      <td>-0.571429</td>
      <td>2219.0</td>
      <td>3467.0</td>
      <td>16909.0</td>
      <td>2818.166667</td>
      <td>2307.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2189894234</td>
      <td>2.2</td>
      <td>23.628571</td>
      <td>0.8</td>
      <td>0.571429</td>
      <td>483.0</td>
      <td>2805.0</td>
      <td>16323.0</td>
      <td>2720.500000</td>
      <td>2558.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2504021639</td>
      <td>286.0</td>
      <td>315.200000</td>
      <td>0.2</td>
      <td>0.000000</td>
      <td>1496.0</td>
      <td>3636.0</td>
      <td>18506.0</td>
      <td>3084.333333</td>
      <td>2206.0</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>mostly Time series feature that are associated with</p>
<ul>
<li><strong>data_download</strong></li>
<li><strong>voice_outgoing</strong></li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">extracted_sig_features_dt</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">((</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;Data&quot;</span><span class="p">,</span><span class="s2">&quot;L1&quot;</span><span class="p">,</span> <span class="s2">&quot;user_cdr_TS_feature.pkl&quot;</span><span class="p">)))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="web">web<a class="anchor-link" href="#web"> </a></h1><p>Overtime web data (monthly visits per user) for 6 months.</p>
<ul>
<li>generate time series features via tsfresh</li>
<li>significant test with churns.</li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">web_dt</span> <span class="o">=</span> <span class="n">dt</span><span class="p">[</span><span class="s1">&#39;telco_web&#39;</span><span class="p">]</span>
<span class="n">web_dt</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>msisdn</th>
      <th>date</th>
      <th>website</th>
      <th>visits</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>6048764759382</td>
      <td>2019-10-31</td>
      <td>www.singtel.com</td>
      <td>620</td>
    </tr>
    <tr>
      <th>1</th>
      <td>6048764759382</td>
      <td>2019-10-31</td>
      <td>www.starhub.com</td>
      <td>267</td>
    </tr>
    <tr>
      <th>2</th>
      <td>6048764759382</td>
      <td>2019-10-31</td>
      <td>www.facebook.com</td>
      <td>4260</td>
    </tr>
    <tr>
      <th>3</th>
      <td>6048764759382</td>
      <td>2019-10-31</td>
      <td>www.instagram.com</td>
      <td>78</td>
    </tr>
    <tr>
      <th>4</th>
      <td>6048764759382</td>
      <td>2019-10-31</td>
      <td>www.cnn.com</td>
      <td>782</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pivot_web</span> <span class="o">=</span> <span class="n">web_dt</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;msisdn&#39;</span><span class="p">,</span><span class="s1">&#39;date&#39;</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;website&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

<span class="c1"># flatten columns</span>
<span class="n">tmp_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">if</span> <span class="n">y</span><span class="o">==</span><span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="n">y</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pivot_web</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">pivot_web</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">1</span><span class="p">))]</span>
<span class="n">tmp_columns_1</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;www.&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.com&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tmp_columns</span><span class="p">]</span>

<span class="c1"># applying manipulated columns</span>
<span class="n">pivot_web</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">tmp_columns_1</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">features_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;maximum&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;minimum&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;absolute_sum_of_changes&quot;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span>
                 <span class="s2">&quot;benford_correlation&quot;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;mean_change&quot;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;sum_values&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;linear_trend&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;attr&#39;</span><span class="p">:</span> <span class="s1">&#39;slope&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;attr&#39;</span><span class="p">:</span> <span class="s1">&#39;intercept&#39;</span><span class="p">}],</span> 
                <span class="p">}</span>
<span class="n">kind_to_fc_parameters</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;cnn&quot;</span><span class="p">:</span> <span class="n">features_dict</span><span class="p">,</span>
    <span class="s2">&quot;facebook&quot;</span><span class="p">:</span> <span class="n">features_dict</span><span class="p">,</span> 
    <span class="s2">&quot;instagram&quot;</span><span class="p">:</span> <span class="n">features_dict</span><span class="p">,</span> 
    <span class="s2">&quot;singtel&quot;</span><span class="p">:</span> <span class="n">features_dict</span><span class="p">,</span>
    <span class="s2">&quot;starhub&quot;</span><span class="p">:</span> <span class="n">features_dict</span>
<span class="p">}</span>
<span class="c1"># calc all the ts features</span>
<span class="n">extracted_features_dt</span> <span class="o">=</span> <span class="n">extract_features</span><span class="p">(</span><span class="n">pivot_web</span><span class="p">,</span> <span class="n">column_id</span> <span class="o">=</span> <span class="s2">&quot;msisdn&quot;</span><span class="p">,</span> <span class="n">column_sort</span> <span class="o">=</span> <span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="n">kind_to_fc_parameters</span> <span class="o">=</span> <span class="n">kind_to_fc_parameters</span><span class="p">)</span>

<span class="c1"># dropping na records</span>
<span class="n">extracted_features_dt</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># generating index for churn for significant check</span>
<span class="n">churn_dt</span> <span class="o">=</span> <span class="n">transform_churn_series</span><span class="p">(</span><span class="n">extracted_features_dt</span> <span class="o">=</span> <span class="n">extracted_features_dt</span><span class="p">,</span> <span class="n">dt_churn</span> <span class="o">=</span> <span class="n">dt</span><span class="p">[</span><span class="s1">&#39;telco_train&#39;</span><span class="p">])</span>

<span class="c1"># significant test and retain only relevent features</span>
<span class="n">relevance_dt</span> <span class="o">=</span> <span class="n">calculate_relevance_table</span><span class="p">(</span><span class="n">extracted_features_dt</span><span class="p">,</span> <span class="n">churn_dt</span><span class="p">[</span><span class="s1">&#39;churn&#39;</span><span class="p">],</span> <span class="n">ml_task</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">sig_columns</span> <span class="o">=</span> <span class="n">relevance_dt</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">relevance_dt</span><span class="p">[</span><span class="s1">&#39;relevant&#39;</span><span class="p">]</span><span class="o">==</span><span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;feature&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">extracted_sig_features_dt</span> <span class="o">=</span> <span class="n">extracted_features_dt</span><span class="p">[</span><span class="n">sig_columns</span><span class="p">]</span>

<span class="c1"># extracted settings</span>
<span class="n">tsfresh</span><span class="o">.</span><span class="n">feature_extraction</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">from_columns</span><span class="p">(</span><span class="n">extracted_features_dt</span><span class="p">[</span><span class="n">sig_columns</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Feature Extraction: 100%|| 30/30 [00:21&lt;00:00,  1.42it/s]
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{&#39;singtel&#39;: {&#39;maximum&#39;: None,
  &#39;sum_values&#39;: None,
  &#39;mean&#39;: None,
  &#39;absolute_sum_of_changes&#39;: None,
  &#39;linear_trend&#39;: [{&#39;attr&#39;: &#39;intercept&#39;}],
  &#39;minimum&#39;: None,
  &#39;benford_correlation&#39;: None},
 &#39;starhub&#39;: {&#39;maximum&#39;: None,
  &#39;sum_values&#39;: None,
  &#39;mean&#39;: None,
  &#39;absolute_sum_of_changes&#39;: None,
  &#39;linear_trend&#39;: [{&#39;attr&#39;: &#39;intercept&#39;}],
  &#39;benford_correlation&#39;: None,
  &#39;minimum&#39;: None}}</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">extracted_sig_features_dt</span> <span class="o">=</span> <span class="n">extracted_sig_features_dt</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;index&#39;</span><span class="p">:</span><span class="s1">&#39;msisdn&#39;</span><span class="p">},</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">extracted_sig_features_dt</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>msisdn</th>
      <th>singtel__maximum</th>
      <th>starhub__maximum</th>
      <th>singtel__sum_values</th>
      <th>singtel__mean</th>
      <th>starhub__sum_values</th>
      <th>starhub__mean</th>
      <th>starhub__absolute_sum_of_changes</th>
      <th>singtel__absolute_sum_of_changes</th>
      <th>starhub__linear_trend__attr_"intercept"</th>
      <th>singtel__linear_trend__attr_"intercept"</th>
      <th>singtel__minimum</th>
      <th>starhub__benford_correlation</th>
      <th>starhub__minimum</th>
      <th>singtel__benford_correlation</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>351144701</td>
      <td>995.0</td>
      <td>805.0</td>
      <td>2903.0</td>
      <td>483.833333</td>
      <td>3221.0</td>
      <td>536.833333</td>
      <td>1317.0</td>
      <td>2307.0</td>
      <td>538.619048</td>
      <td>477.047619</td>
      <td>155.0</td>
      <td>-0.210476</td>
      <td>245.0</td>
      <td>0.250905</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1041740389</td>
      <td>857.0</td>
      <td>896.0</td>
      <td>2468.0</td>
      <td>411.333333</td>
      <td>3458.0</td>
      <td>576.333333</td>
      <td>1697.0</td>
      <td>2082.0</td>
      <td>403.904762</td>
      <td>139.190476</td>
      <td>27.0</td>
      <td>-0.183830</td>
      <td>219.0</td>
      <td>0.382712</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1529121439</td>
      <td>1320.0</td>
      <td>1038.0</td>
      <td>3474.0</td>
      <td>579.000000</td>
      <td>4280.0</td>
      <td>713.333333</td>
      <td>1699.0</td>
      <td>2270.0</td>
      <td>494.761905</td>
      <td>350.571429</td>
      <td>250.0</td>
      <td>-0.074306</td>
      <td>44.0</td>
      <td>0.442830</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2189894234</td>
      <td>834.0</td>
      <td>794.0</td>
      <td>3015.0</td>
      <td>502.500000</td>
      <td>3949.0</td>
      <td>658.166667</td>
      <td>602.0</td>
      <td>1730.0</td>
      <td>577.666667</td>
      <td>416.857143</td>
      <td>129.0</td>
      <td>-0.367161</td>
      <td>506.0</td>
      <td>0.355335</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2504021639</td>
      <td>867.0</td>
      <td>755.0</td>
      <td>3608.0</td>
      <td>601.333333</td>
      <td>2812.0</td>
      <td>468.666667</td>
      <td>1030.0</td>
      <td>1055.0</td>
      <td>450.809524</td>
      <td>555.904762</td>
      <td>468.0</td>
      <td>-0.002136</td>
      <td>226.0</td>
      <td>-0.303096</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>mostly Time series feature that are associated with</p>
<ul>
<li><strong>singtel</strong></li>
<li><strong>starhub</strong></li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">extracted_sig_features_dt</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">((</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;Data&quot;</span><span class="p">,</span><span class="s2">&quot;L1&quot;</span><span class="p">,</span> <span class="s2">&quot;user_web_TS_feature.pkl&quot;</span><span class="p">)))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

