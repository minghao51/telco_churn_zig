---

title: 02 geolocation churn 

keywords: fastai
sidebar: home_sidebar

summary: "Combining data on geo location level, given that the current calculation is done on planning_area (far too few points), I will just be doing visualisation with powerBI."
description: "Combining data on geo location level, given that the current calculation is done on planning_area (far too few points), I will just be doing visualisation with powerBI."
nb_path: "02B_geolocation_profile.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 02B_geolocation_profile.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Library">Library<a class="anchor-link" href="#Library"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#exports</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">zipfile</span> <span class="kn">import</span> <span class="n">ZipFile</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">spatial</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">tsfresh</span> <span class="kn">import</span> <span class="n">extract_features</span>
<span class="kn">from</span> <span class="nn">tsfresh.feature_selection.relevance</span> <span class="kn">import</span> <span class="n">calculate_relevance_table</span>
<span class="kn">import</span> <span class="nn">tsfresh</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="kn">import</span> <span class="n">AgglomerativeClustering</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">ExtraTreesClassifier</span><span class="p">,</span> <span class="n">ExtraTreesRegressor</span><span class="p">,</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">GridSearchCV</span>
<span class="kn">from</span> <span class="nn">sklearn.inspection</span> <span class="kn">import</span> <span class="n">plot_partial_dependence</span>
<span class="kn">from</span> <span class="nn">sklearn.impute</span> <span class="kn">import</span> <span class="n">SimpleImputer</span>

<span class="n">imp_mean</span> <span class="o">=</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">missing_values</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span>
<span class="n">imp_med</span> <span class="o">=</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">missing_values</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">balanced_accuracy_score</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">classification_report</span>
<span class="kn">from</span> <span class="nn">sklearn.inspection</span> <span class="kn">import</span> <span class="n">permutation_importance</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Functions">Functions<a class="anchor-link" href="#Functions"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">read_tsv</span><span class="p">(</span><span class="n">file</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span>  <span class="n">compression</span><span class="o">=</span><span class="s1">&#39;gzip&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">gzip_reading</span><span class="p">(</span><span class="n">gzip_file</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">dict</span><span class="p">:</span>
    <span class="s1">&#39;Read all tsv.gz files in the zip file and returning a dictionary (key:filename, value:data)&#39;</span>
    <span class="n">archive</span> <span class="o">=</span> <span class="n">ZipFile</span><span class="p">(</span><span class="n">gzip_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">files</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">archive</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">archive</span><span class="o">.</span><span class="n">namelist</span><span class="p">()</span> <span class="k">if</span>
     <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.gz&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">))}</span>
    <span class="n">files_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">files</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
    
    <span class="c1"># reading the designated files into dict</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">files_names</span><span class="p">,</span> <span class="n">files</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">dt</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_tsv</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">dt</span>

<span class="k">def</span> <span class="nf">load_directory_files_dict</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">dict</span><span class="p">:</span>
    <span class="s1">&#39;Load all pkl files in the directory into dict&#39;</span>
    <span class="n">L1file_list</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path_load</span><span class="p">)</span>
    <span class="n">L1file_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">L1file_list</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)]</span>
    <span class="n">L1name_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.pkl&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">L1file_list</span><span class="p">]</span>

    <span class="n">dt</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">L1file_list</span><span class="p">,</span> <span class="n">L1name_list</span><span class="p">):</span>
        <span class="n">dt</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_load</span><span class="p">,</span><span class="n">name</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">dt</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="read_tsv" class="doc_header"><code>read_tsv</code><a href="https://github.com/howt51/telco_churn_zig/tree/master/telco_churn_zig/L2B_geo_model_explore/py.py#L35" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>read_tsv</code>(<strong><code>file</code></strong>:<code>str</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="gzip_reading" class="doc_header"><code>gzip_reading</code><a href="https://github.com/howt51/telco_churn_zig/tree/master/telco_churn_zig/L2B_geo_model_explore/py.py#L38" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>gzip_reading</code>(<strong><code>gzip_file</code></strong>)</p>
</blockquote>
<p>Read all tsv.gz files in the zip file and returning a dictionary (key:filename, value:data)</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="load_directory_files_dict" class="doc_header"><code>load_directory_files_dict</code><a href="https://github.com/howt51/telco_churn_zig/tree/master/telco_churn_zig/L2B_geo_model_explore/py.py#L51" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>load_directory_files_dict</code>(<strong><code>dir_path</code></strong>)</p>
</blockquote>
<p>Load all pkl files in the directory into dict</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Data">Data<a class="anchor-link" href="#Data"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">path_load</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;Data&quot;</span><span class="p">,</span><span class="s2">&quot;L1&quot;</span><span class="p">)</span>
<span class="n">path_save</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;Data&quot;</span><span class="p">,</span><span class="s2">&quot;L2&quot;</span><span class="p">)</span>

<span class="n">dt</span> <span class="o">=</span> <span class="n">load_directory_files_dict</span><span class="p">(</span><span class="n">path_load</span><span class="p">)</span>
<span class="n">raw</span> <span class="o">=</span> <span class="n">gzip_reading</span><span class="p">(</span><span class="s1">&#39;telco_demo_datasets.zip&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="geo-profile">geo profile<a class="anchor-link" href="#geo-profile"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">geo_train</span> <span class="o">=</span> <span class="n">dt</span><span class="p">[</span><span class="s1">&#39;geo_train&#39;</span><span class="p">]</span>
<span class="n">geo_loc</span> <span class="o">=</span> <span class="p">(</span><span class="n">dt</span><span class="p">[</span><span class="s1">&#39;geo_location&#39;</span><span class="p">]</span>
           <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;planning_area&#39;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
           <span class="o">.</span><span class="n">size</span><span class="p">()</span>
           <span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;size&#39;</span><span class="p">:</span><span class="s1">&#39;visits&#39;</span><span class="p">},</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
          <span class="p">)</span>
<span class="n">geo_census</span> <span class="o">=</span> <span class="n">dt</span><span class="p">[</span><span class="s1">&#39;geo_census&#39;</span><span class="p">]</span>
<span class="n">geo_school</span> <span class="o">=</span> <span class="n">dt</span><span class="p">[</span><span class="s1">&#39;geo_school&#39;</span><span class="p">]</span>
<span class="n">geo_coor</span> <span class="o">=</span> <span class="n">dt</span><span class="p">[</span><span class="s1">&#39;geo_coor&#39;</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">geo_dt</span> <span class="o">=</span> <span class="p">(</span><span class="n">geo_train</span>
          <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">geo_coor</span><span class="p">)</span>
          <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">geo_loc</span><span class="p">)</span>
          <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">geo_census</span><span class="p">)</span>
          <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">geo_school</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># print data</span>
<span class="n">geo_dt</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>planning_area</th>
      <th>age</th>
      <th>contract</th>
      <th>internet_service</th>
      <th>account_start_year</th>
      <th>month_delta</th>
      <th>churn</th>
      <th>lat</th>
      <th>lng</th>
      <th>users_nb</th>
      <th>visits</th>
      <th>med_income</th>
      <th>avg_income</th>
      <th>gini_coef</th>
      <th>pop</th>
      <th>working_pop</th>
      <th>number_school</th>
      <th>integrated_schools</th>
      <th>primary_schools</th>
      <th>secondary_schools</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>ANG MO KIO</td>
      <td>38.967391</td>
      <td>0.531621</td>
      <td>0.443676</td>
      <td>2014.265810</td>
      <td>65.870553</td>
      <td>0.093874</td>
      <td>1.371236</td>
      <td>103.847778</td>
      <td>1012</td>
      <td>373</td>
      <td>2500</td>
      <td>5254.007202</td>
      <td>0.427458</td>
      <td>59705</td>
      <td>51238</td>
      <td>17</td>
      <td>1.0</td>
      <td>8.0</td>
      <td>8.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>BEDOK</td>
      <td>39.557133</td>
      <td>0.555105</td>
      <td>0.465855</td>
      <td>2014.260987</td>
      <td>65.876944</td>
      <td>0.077755</td>
      <td>1.331222</td>
      <td>103.928134</td>
      <td>1479</td>
      <td>575</td>
      <td>2500</td>
      <td>6066.907469</td>
      <td>0.383530</td>
      <td>91224</td>
      <td>80081</td>
      <td>24</td>
      <td>1.0</td>
      <td>12.0</td>
      <td>11.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>BISHAN</td>
      <td>38.417323</td>
      <td>0.511811</td>
      <td>0.527559</td>
      <td>2014.070866</td>
      <td>67.992126</td>
      <td>0.196850</td>
      <td>1.355431</td>
      <td>103.839107</td>
      <td>127</td>
      <td>406</td>
      <td>3500</td>
      <td>7303.412733</td>
      <td>0.302858</td>
      <td>27457</td>
      <td>24602</td>
      <td>15</td>
      <td>3.0</td>
      <td>4.0</td>
      <td>8.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>BUKIT BATOK</td>
      <td>40.536050</td>
      <td>0.530564</td>
      <td>0.472571</td>
      <td>2014.325235</td>
      <td>65.303292</td>
      <td>0.063480</td>
      <td>1.351252</td>
      <td>103.750406</td>
      <td>1276</td>
      <td>146</td>
      <td>3500</td>
      <td>6627.432987</td>
      <td>0.328079</td>
      <td>44133</td>
      <td>40681</td>
      <td>11</td>
      <td>0.0</td>
      <td>6.0</td>
      <td>5.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>BUKIT MERAH</td>
      <td>39.228438</td>
      <td>0.543124</td>
      <td>0.510490</td>
      <td>2014.235431</td>
      <td>66.386946</td>
      <td>0.118881</td>
      <td>1.279427</td>
      <td>103.822536</td>
      <td>429</td>
      <td>4404</td>
      <td>1500</td>
      <td>4930.564294</td>
      <td>0.469347</td>
      <td>55627</td>
      <td>45316</td>
      <td>13</td>
      <td>0.0</td>
      <td>8.0</td>
      <td>5.0</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">geo_dt</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(21, 20)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>With only 21 records and 20 features... I should have perhaps calculate it on finer lat, lon instaed of planning area...</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="output">output<a class="anchor-link" href="#output"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">geo_dt</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_save</span><span class="p">,</span> <span class="s2">&quot;geo_profile.pkl&quot;</span><span class="p">))</span>
<span class="n">geo_dt</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_save</span><span class="p">,</span> <span class="s2">&quot;geo_profile.csv&quot;</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="geo-visit-Location">geo visit Location<a class="anchor-link" href="#geo-visit-Location"> </a></h2><p>clustering on locations visited for users</p>
<ul>
<li>hclust on lat,lon with 60 clusters</li>
<li>calculate the mean churn % within clusters</li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">X_cluster_dt</span> <span class="o">=</span> <span class="n">raw</span><span class="p">[</span><span class="s1">&#39;telco_locations&#39;</span><span class="p">][[</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span><span class="s1">&#39;longitude&#39;</span><span class="p">,</span><span class="s1">&#39;msisdn&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dt</span><span class="p">[</span><span class="s1">&#39;user_train&#39;</span><span class="p">][[</span><span class="s1">&#39;msisdn&#39;</span><span class="p">,</span><span class="s1">&#39;churn&#39;</span><span class="p">]])</span>
<span class="n">X_cluster_dt</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>latitude</th>
      <th>longitude</th>
      <th>msisdn</th>
      <th>churn</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1.326087</td>
      <td>103.898460</td>
      <td>6048764759382</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1.292531</td>
      <td>103.825648</td>
      <td>6048764759382</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1.301823</td>
      <td>103.904991</td>
      <td>1948924115781</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1.301866</td>
      <td>103.837118</td>
      <td>1948924115781</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1.301894</td>
      <td>103.904761</td>
      <td>5938778408016</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">cluster</span> <span class="o">=</span> <span class="n">AgglomerativeClustering</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">affinity</span><span class="o">=</span><span class="s1">&#39;euclidean&#39;</span><span class="p">,</span> <span class="n">linkage</span><span class="o">=</span><span class="s1">&#39;ward&#39;</span><span class="p">)</span>
<span class="n">cluster</span><span class="o">.</span><span class="n">fit_predict</span><span class="p">(</span><span class="n">X_cluster_dt</span><span class="p">[[</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span><span class="s1">&#39;longitude&#39;</span><span class="p">]])</span>

<span class="n">X_cluster_dt</span><span class="p">[</span><span class="s1">&#39;cluster&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">labels_</span>
<span class="n">X_cluster_dt</span><span class="p">[</span><span class="s1">&#39;churn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X_cluster_dt</span><span class="o">.</span><span class="n">churn</span>

<span class="n">X_cluster_agg_dt</span> <span class="o">=</span> <span class="n">X_cluster_dt</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;cluster&#39;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;latitude&#39;</span><span class="p">:</span><span class="s1">&#39;median&#39;</span><span class="p">,</span><span class="s1">&#39;longitude&#39;</span><span class="p">:</span><span class="s1">&#39;median&#39;</span><span class="p">,</span><span class="s1">&#39;churn&#39;</span><span class="p">:</span><span class="s1">&#39;mean&#39;</span><span class="p">})</span>
<span class="n">X_cluster_agg_dt</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>cluster</th>
      <th>latitude</th>
      <th>longitude</th>
      <th>churn</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>1.280635</td>
      <td>103.848045</td>
      <td>0.116236</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>1.326771</td>
      <td>103.846719</td>
      <td>0.102916</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>1.307370</td>
      <td>103.789107</td>
      <td>0.128079</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
      <td>1.360945</td>
      <td>103.893404</td>
      <td>0.103226</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4</td>
      <td>1.293947</td>
      <td>103.784791</td>
      <td>0.135472</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="output">output<a class="anchor-link" href="#output"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">X_cluster_agg_dt</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_save</span><span class="p">,</span> <span class="s2">&quot;geo_visit.pkl&quot;</span><span class="p">))</span>
<span class="n">X_cluster_agg_dt</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_save</span><span class="p">,</span> <span class="s2">&quot;geo_visit.csv&quot;</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

