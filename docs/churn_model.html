---

title: 03A user churn model

keywords: fastai
sidebar: home_sidebar

summary: "packaging churn model, given records similar to user_profile (combined data and feature generated from various sources)"
description: "packaging churn model, given records similar to user_profile (combined data and feature generated from various sources)"
nb_path: "03A_churn_model.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 03A_churn_model.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Library">Library<a class="anchor-link" href="#Library"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#exports</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">ExtraTreesClassifier</span><span class="p">,</span> <span class="n">ExtraTreesRegressor</span><span class="p">,</span> <span class="n">RandomForestClassifier</span><span class="p">,</span> <span class="n">RandomForestRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.compose</span> <span class="kn">import</span> <span class="n">ColumnTransformer</span>
<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">import</span> <span class="nn">joblib</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Functions">Functions<a class="anchor-link" href="#Functions"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">load_directory_files_dict</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">dict</span><span class="p">:</span>
    <span class="s1">&#39;Load all pkl files in the directory into dict&#39;</span>
    <span class="n">L1file_list</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path_load</span><span class="p">)</span>
    <span class="n">L1file_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">L1file_list</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">i</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.pkl&#39;</span><span class="p">)]</span>
    <span class="n">L1name_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.pkl&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">L1file_list</span><span class="p">]</span>

    <span class="n">dt</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">L1file_list</span><span class="p">,</span> <span class="n">L1name_list</span><span class="p">):</span>
        <span class="n">dt</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_load</span><span class="p">,</span><span class="n">name</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">dt</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="load_directory_files_dict" class="doc_header"><code>load_directory_files_dict</code><a href="https://github.com/howt51/telco_churn_zig/tree/master/telco_churn_zig/L3A_user_model/py.py#L20" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>load_directory_files_dict</code>(<strong><code>dir_path</code></strong>)</p>
</blockquote>
<p>Load all pkl files in the directory into dict</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="data">data<a class="anchor-link" href="#data"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">path_load</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;Data&quot;</span><span class="p">,</span><span class="s2">&quot;L2&quot;</span><span class="p">)</span>
<span class="n">path_save</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;Data&quot;</span><span class="p">,</span><span class="s2">&quot;L3&quot;</span><span class="p">)</span>

<span class="n">dt</span> <span class="o">=</span> <span class="n">load_directory_files_dict</span><span class="p">(</span><span class="n">path_load</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dt</span><span class="p">[</span><span class="s1">&#39;user_profile&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>msisdn</th>
      <th>churn</th>
      <th>train__age</th>
      <th>train__contract</th>
      <th>train__internet_service</th>
      <th>train__account_start_year</th>
      <th>planning_area</th>
      <th>train__month_delta</th>
      <th>census__med_income</th>
      <th>census__avg_income</th>
      <th>...</th>
      <th>web__starhub__sum_values</th>
      <th>web__starhub__mean</th>
      <th>web__starhub__absolute_sum_of_changes</th>
      <th>web__singtel__absolute_sum_of_changes</th>
      <th>web__starhub__linear_trend__attr_"intercept"</th>
      <th>web__singtel__linear_trend__attr_"intercept"</th>
      <th>web__singtel__minimum</th>
      <th>web__starhub__benford_correlation</th>
      <th>web__starhub__minimum</th>
      <th>web__singtel__benford_correlation</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>6048764759382</td>
      <td>0</td>
      <td>44</td>
      <td>0</td>
      <td>1</td>
      <td>2018</td>
      <td>TOA PAYOH</td>
      <td>25</td>
      <td>1500</td>
      <td>5089.771035</td>
      <td>...</td>
      <td>1779.0</td>
      <td>296.500000</td>
      <td>1213.0</td>
      <td>2009.0</td>
      <td>133.571429</td>
      <td>630.857143</td>
      <td>184.0</td>
      <td>0.473221</td>
      <td>79.0</td>
      <td>0.057715</td>
    </tr>
    <tr>
      <th>1</th>
      <td>891319344217</td>
      <td>0</td>
      <td>56</td>
      <td>1</td>
      <td>1</td>
      <td>2010</td>
      <td>TOA PAYOH</td>
      <td>117</td>
      <td>1500</td>
      <td>5089.771035</td>
      <td>...</td>
      <td>4656.0</td>
      <td>776.000000</td>
      <td>2144.0</td>
      <td>2499.0</td>
      <td>919.714286</td>
      <td>244.857143</td>
      <td>140.0</td>
      <td>-0.026776</td>
      <td>310.0</td>
      <td>0.383169</td>
    </tr>
    <tr>
      <th>2</th>
      <td>99251853671</td>
      <td>0</td>
      <td>26</td>
      <td>0</td>
      <td>1</td>
      <td>2007</td>
      <td>TOA PAYOH</td>
      <td>151</td>
      <td>1500</td>
      <td>5089.771035</td>
      <td>...</td>
      <td>3502.0</td>
      <td>583.666667</td>
      <td>2862.0</td>
      <td>1306.0</td>
      <td>444.523810</td>
      <td>293.380952</td>
      <td>76.0</td>
      <td>0.662261</td>
      <td>17.0</td>
      <td>-0.282165</td>
    </tr>
    <tr>
      <th>3</th>
      <td>9795194264183</td>
      <td>0</td>
      <td>48</td>
      <td>0</td>
      <td>0</td>
      <td>2014</td>
      <td>TOA PAYOH</td>
      <td>73</td>
      <td>1500</td>
      <td>5089.771035</td>
      <td>...</td>
      <td>4214.0</td>
      <td>702.333333</td>
      <td>1985.0</td>
      <td>995.0</td>
      <td>947.476190</td>
      <td>609.190476</td>
      <td>176.0</td>
      <td>0.055723</td>
      <td>440.0</td>
      <td>0.077998</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5833245602906</td>
      <td>0</td>
      <td>52</td>
      <td>0</td>
      <td>0</td>
      <td>2018</td>
      <td>TOA PAYOH</td>
      <td>15</td>
      <td>1500</td>
      <td>5089.771035</td>
      <td>...</td>
      <td>3069.0</td>
      <td>511.500000</td>
      <td>1605.0</td>
      <td>764.0</td>
      <td>237.571429</td>
      <td>386.809524</td>
      <td>311.0</td>
      <td>0.140976</td>
      <td>82.0</td>
      <td>-0.110172</td>
    </tr>
  </tbody>
</table>
<p>5 rows Ã— 40 columns</p>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="target/features-seperation">target/features seperation<a class="anchor-link" href="#target/features-seperation"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">y</span> <span class="o">=</span> <span class="n">dt</span><span class="p">[</span><span class="s1">&#39;user_profile&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;churn&#39;</span><span class="p">)</span>
<span class="n">X_columns</span> <span class="o">=</span> <span class="n">dt</span><span class="p">[</span><span class="s1">&#39;user_profile&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">dt</span><span class="p">[</span><span class="s1">&#39;user_profile&#39;</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="sklearn-pipeline">sklearn pipeline<a class="anchor-link" href="#sklearn-pipeline"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># drop unnessary features</span>
<span class="c1"># then uses a RandomForestClassifier to train the model.</span>

<span class="n">dropping_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;msdidn&#39;</span><span class="p">,</span><span class="s1">&#39;planning_area&#39;</span><span class="p">]</span>
<span class="n">drop_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">X_columns</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dropping_columns</span><span class="p">]</span>

<span class="n">pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
      <span class="p">(</span><span class="s2">&quot;select&quot;</span><span class="p">,</span> <span class="n">ColumnTransformer</span><span class="p">([(</span><span class="s1">&#39;drop&#39;</span><span class="p">,</span><span class="s1">&#39;drop&#39;</span><span class="p">,</span> <span class="n">drop_idx</span><span class="p">)],</span> <span class="n">remainder</span><span class="o">=</span><span class="s1">&#39;passthrough&#39;</span><span class="p">)),</span>  <span class="c1"># filtering for index columns</span>
      <span class="p">(</span><span class="s1">&#39;classification&#39;</span><span class="p">,</span> <span class="n">RandomForestClassifier</span><span class="p">(</span> 
          <span class="n">class_weight</span><span class="o">=</span><span class="s1">&#39;balanced_subsample&#39;</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                       <span class="n">min_samples_leaf</span><span class="o">=</span><span class="mf">0.03</span><span class="p">,</span> <span class="n">n_estimators</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                       <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># model</span>
      <span class="p">)</span>
    <span class="p">])</span>

<span class="n">pipeline</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="c1"># Export the classifier to a file</span>
<span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_save</span><span class="p">,</span> <span class="s1">&#39;RF_churn_model.joblib&#39;</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[&#39;Data\\L3\\RF_churn_model.joblib&#39;]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="prediction">prediction<a class="anchor-link" href="#prediction"> </a></h3><p>with the saved sklearn joblib pipeline</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pipeline</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">[:</span><span class="mi">1</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>array([0])</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

